@page "/portfolio/{id:int}"
@using WebAthenPs.Models.DTOs.Professional
@using WebAthenPs.Models.DTOs.Project
@using WebAthenPs.Models.DTOs.Components
@using WebAthenPs.Project.Components.Components
@using WebAthenPs.Project.Services.Interfaces.Professional
@using WebAthenPs.Project.Services.Interfaces.Project
@using WebAthenPs.Project.Services.Interfaces.Components
@using Blazored.LocalStorage
@using WebAthenPs.Project.Services.Interfaces.User
@inject IGenericProfessionalService ProfessionalService
@inject IProjectService ProjectService
@inject IPostService PostService
@inject ICommentService CommentService
@inject ILocalStorageService LocalStorage
@inject IAuthService _authService


@code {
    [Parameter] public int id { get; set; }

    private GenericProfessionalDTO _professional;
    private List<ProjectsDTO> _projects = new List<ProjectsDTO>();
    private List<PostDTO> _posts = new List<PostDTO>();
    private List<CommentDTO> _comments = new List<CommentDTO>();
    private bool _isLoading = true;
    private string _newCommentContent;
    private int _selectedPostId;
    private string _currentUserId;
    private Dictionary<int, List<CommentDTO>> _commentsByPost = new Dictionary<int, List<CommentDTO>>();

    private bool showProposalModal = false; // Controlar a visibilidade do modal
    private int selectedProfessionalIdForProposal = 0; // Id do profissional selecionado para o modal

    // Ao inicializar, carrega as informações do profissional, projetos e posts.
    protected override async Task OnInitializedAsync()
    {
        await LoadUserIdFromLocalStorage();
        await LoadProfessionalDetails();
        await LoadProjects();
        await LoadPosts();
    }
    // Adiciona um novo comentário a um post específico
    private async Task AddCommentAsync()
    {
        try
        {
            // Verifica se o conteúdo do comentário e o ID do post são válidos
            if (!string.IsNullOrWhiteSpace(_newCommentContent) && _selectedPostId > 0)
            {
                // Obtém o UserId do serviço de autenticação
                var userId = await _authService.GetUserIdFromToken(); // Chama o serviço para pegar o UserId

                if (string.IsNullOrEmpty(userId))
                {
                    Console.WriteLine("Usuário não autenticado.");
                    return; // Se o UserId não for válido, retorna e não faz a criação do comentário
                }

                // Cria o DTO do comentário com o conteúdo, UserId e PostId
                var commentDto = new CommentCreateDTO
                    {
                        Content = _newCommentContent,
                        UserId = userId, // Utiliza o UserId obtido do AuthService
                        PostId = _selectedPostId
                    };

                // Chama o serviço para criar o comentário
                var createdComment = await CommentService.CreateComment(commentDto);

                if (createdComment != null)
                {
                    // Atualiza a lista de comentários para o post selecionado
                    if (_commentsByPost.ContainsKey(_selectedPostId))
                    {
                        _commentsByPost[_selectedPostId].Add(createdComment);
                    }
                    else
                    {
                        _commentsByPost[_selectedPostId] = new List<CommentDTO> { createdComment };
                    }

                    // Limpa o campo de conteúdo do comentário
                    _newCommentContent = string.Empty;

                    // Força a atualização da interface do usuário
                    StateHasChanged();
                }
                else
                {
                    Console.WriteLine("Falha ao criar o comentário.");
                }
            }
            else
            {
                Console.WriteLine("Conteúdo do comentário ou ID do post inválido.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao adicionar comentário: {ex.Message}");
        }
    }

    private async Task LoadUserIdFromLocalStorage()
    {
        _currentUserId = await LocalStorage.GetItemAsync<string>("userId");

        if (string.IsNullOrEmpty(_currentUserId))
        {
            Console.WriteLine("Usuário não está logado.");
        }
    }

    private async Task LoadProfessionalDetails()
    {
        try
        {
            _professional = await ProfessionalService.GetByIdAsync(id);

            if (_professional == null)
            {
                throw new Exception("Profissional não encontrado.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao buscar detalhes do profissional: {ex.Message}");
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadProjects()
    {
        try
        {
            if (_professional != null && _professional.ProjectProfessionals.Any())
            {
                var projectIds = _professional.ProjectProfessionals.Select(pp => pp.ProjectId).ToList();
                var projects = new List<ProjectsDTO>();

                foreach (var projectId in projectIds)
                {
                    var project = await ProjectService.GetById(projectId);
                    if (project != null)
                    {
                        projects.Add(project);
                    }
                }

                _projects = projects;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao buscar projetos: {ex.Message}");
        }
    }

    private async Task LoadPosts()
    {
        try
        {
            var userId = _professional?.UserId;
            if (!string.IsNullOrEmpty(userId))
            {
                _posts = (await PostService.GetPostsByUserIdAsync(userId)).ToList();

                foreach (var post in _posts)
                {
                    var postComments = await CommentService.GetByPostId(post.Id);
                    _commentsByPost[post.Id] = postComments.ToList();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Erro ao buscar posts e comentários: {ex.Message}");
        }
    }

    // Método para abrir o modal com base no ID do profissional
    private void OpenProposalModal(int professionalId)
    {
        selectedProfessionalIdForProposal = professionalId;
        showProposalModal = true; // Exibe o modal
    }

    // Método para fechar o modal
    private void CloseProposalModal()
    {
        showProposalModal = false;
    }
}

@if (_isLoading)
{
    <p>Carregando...</p>
}
else if (_professional == null)
{
    <p>Profissional não encontrado.</p>
}
else
{
    <div class="portfolio">
        <!-- Dados do Profissional -->
        <div class="header">
            <img src="images/profile-placeholder.png" alt="Foto do Profissional" class="profile-pic" />
            <h1>@(_professional.UserName ?? "Nome não disponível")</h1>
            <p class="contact-info">
                <strong>Email:</strong> @(_professional.Email ?? "Email não disponível")<br />
                <strong>Telefone:</strong> @(_professional.PhoneNumber ?? "Telefone não disponível")
            </p>
        </div>

        <!-- Botão para abrir o modal -->
        <button class="btn btn-primary" @onclick="() => OpenProposalModal(_professional.Id)">
            Solicitar Proposta
        </button>

        <!-- Exibe o modal se showProposalModal for true -->
        @if (showProposalModal)
        {
            <ProposalModal ModalProfessionalId="selectedProfessionalIdForProposal" OnClose="CloseProposalModal" />
        }

        <!-- Sobre o Profissional -->
        <div class="about">
            <h2>Sobre</h2>
            <p>@(@* _professional.Bio ??  *@"Informações adicionais não disponíveis.")</p>
        </div>

        <!-- Áreas de Atuação -->
        <div class="skills">
            <h2>Áreas de Atuação</h2>
            <ul>
                @foreach (var type in _professional.ProfessionalTypes)
                {
                    <li>@type</li>
                }
            </ul>
        </div>

        <!-- Listagem de Projetos -->
        @if (_projects.Any())
        {
            <div class="projects">
                <h2>Projetos Realizados</h2>
                <div class="project-list">
                    @foreach (var project in _projects)
                    {
                        <div class="project-card">
                            <h3>@project.ProjectName</h3>
                            <p><strong>Tipo de Construção:</strong> @project.ConstructionType</p>
                            <p><strong>Status:</strong> @project.Status</p>
                            <p><strong>Data de Início:</strong> @project.StartDate.ToShortDateString()</p>
                            <p><strong>Data de Término:</strong> @(project.EndDate.HasValue ? project.EndDate.Value.ToShortDateString() : "Não concluído")</p>
                            <p><strong>Orçamento:</strong> @project.Budget.HasValue ? $"R${project.Budget.Value:N2}" : "Não disponível"</p>
                            <p><strong>Cliente:</strong> @project.ClientName</p>
                            <p><strong>Endereço:</strong> @project.Address, @project.Neighborhood, @project.City - @project.State, @project.PostalCode, @project.Country</p>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Listagem de Posts -->
        @if (_posts.Any())
        {
            <div class="posts">
                <h2>Posts do Profissional</h2>
                <div class="post-list">
                    @foreach (var post in _posts)
                    {
                        <div class="post-card">
                            <p>@post.Content</p>
                            <p><strong>Data de Criação:</strong> @post.CreatedAt.ToShortDateString()</p>
                            <button @onclick="() => _selectedPostId = post.Id">Adicionar Comentário</button>
                            @if (_selectedPostId == post.Id)
                            {
                                <div class="comment-section">
                                    <textarea @bind="_newCommentContent" placeholder="Digite seu comentário..."></textarea>
                                    <button @onclick="AddCommentAsync">Enviar</button>
                                </div>
                            }
                            @if (_commentsByPost.TryGetValue(post.Id, out var comments) && comments.Any())
                            {
                                <div class="comments">
                                    @foreach (var comment in comments)
                                    {
                                        <div class="comment-card">
                                            <p>@comment.Content</p>
                                            <p><strong>Comentado em:</strong> @comment.CreatedAt.ToShortDateString()</p>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
}

<style>
    .portfolio {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        font-family: Arial, sans-serif;
    }

    .header {
        text-align: center;
    }

    .profile-pic {
        border-radius: 50%;
        width: 150px;
        height: 150px;
        object-fit: cover;
    }

    h1 {
        font-size: 2.5em;
        margin-top: 0.5em;
    }

    .contact-info {
        margin-top: 10px;
        font-size: 1.1em;
        color: #555;
    }

    .about, .skills, .projects, .posts {
        margin-top: 40px;
    }

    .about p {
        font-size: 1.2em;
        color: #666;
    }

    .projects .project-card {
        padding: 15px;
        background: #f7f7f7;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .posts .post-card {
        padding: 15px;
        background: #eaeaea;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        max-width: 500px;
        width: 100%;
    }

    .btn {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    .btn:hover {
        background-color: #0056b3;
    }
</style>
